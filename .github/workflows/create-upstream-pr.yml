# ============================================================
# Create PR on upstream dw-0/kiauh
#
# Required secret:
#   UPSTREAM_PAT  — GitHub Personal Access Token with `repo`
#                   scope belonging to itdir (or any account
#                   that can fork dw-0/kiauh and open PRs).
#
# Usage: Actions → "Create Upstream PR" → Run workflow
# ============================================================
name: Create Upstream PR

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: Branch name to create in the upstream fork
        required: true
        default: feat/configurable-base-dir
        type: string
      pr_title:
        description: Pull-request title
        required: true
        default: "feat: configurable BASE_DIR for component/extension installations"
        type: string
      draft:
        description: Open as draft PR
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  create-upstream-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read        # only needs to read this fork

    env:
      GH_TOKEN: ${{ secrets.UPSTREAM_PAT }}
      UPSTREAM_REPO: dw-0/kiauh
      BRANCH: ${{ inputs.branch_name }}

    steps:
      # ── 1. Check out this fork (source of truth for changed files) ──────
      - name: Checkout this fork
        uses: actions/checkout@v4
        with:
          ref: master
          path: this-fork

      # ── 2. Fork dw-0/kiauh under the PAT owner's account (idempotent) ───
      - name: Fork upstream repo
        run: |
          gh repo fork "$UPSTREAM_REPO" \
            --clone=false \
            --default-branch-only \
          || echo "Fork already exists — continuing"

      # ── 3. Determine fork owner from the PAT ────────────────────────────
      - name: Get fork owner
        id: whoami
        run: |
          owner=$(gh api user --jq '.login')
          echo "owner=$owner" >> "$GITHUB_OUTPUT"
          echo "Fork owner: $owner"

      # ── 4. Clone the fork and create a feature branch from upstream ──────
      - name: Set up feature branch in fork
        run: |
          fork="${{ steps.whoami.outputs.owner }}/kiauh"
          gh repo clone "$fork" fork-clone
          cd fork-clone
          git remote add upstream "https://github.com/$UPSTREAM_REPO.git"
          git fetch upstream master
          # Create branch; if it already exists, reset it
          if git ls-remote --exit-code --heads origin "$BRANCH"; then
            git checkout -B "$BRANCH" upstream/master
            git push --force origin "$BRANCH"
          else
            git checkout -b "$BRANCH" upstream/master
          fi

      # ── 5. Copy the 26 files that differ from upstream ───────────────────
      - name: Apply changes from this fork
        run: |
          set -e
          CHANGED_FILES=(
            default.kiauh.cfg
            kiauh/components/crowsnest/__init__.py
            kiauh/components/klipper/__init__.py
            kiauh/components/klipperscreen/__init__.py
            kiauh/components/moonraker/__init__.py
            kiauh/components/moonraker/utils/utils.py
            kiauh/components/webui_client/client_utils.py
            kiauh/components/webui_client/fluidd_data.py
            kiauh/components/webui_client/mainsail_data.py
            kiauh/core/constants.py
            kiauh/core/services/backup_service.py
            kiauh/core/settings/kiauh_settings.py
            kiauh/extensions/gcode_shell_cmd/__init__.py
            kiauh/extensions/klipper_backup/__init__.py
            kiauh/extensions/mobileraker/__init__.py
            kiauh/extensions/obico/__init__.py
            kiauh/extensions/octoapp/__init__.py
            kiauh/extensions/octoeverywhere/__init__.py
            kiauh/extensions/octoprint/octoprint.py
            kiauh/extensions/pretty_gcode/pretty_gcode_extension.py
            kiauh/extensions/spoolman/__init__.py
            kiauh/extensions/telegram_bot/__init__.py
            kiauh/extensions/tmc_autotune/__init__.py
            kiauh/main.py
            kiauh/utils/fs_utils.py
            kiauh/utils/sys_utils.py
          )
          for f in "${CHANGED_FILES[@]}"; do
            cp "this-fork/$f" "fork-clone/$f"
          done

      # ── 6. Commit and push ───────────────────────────────────────────────
      - name: Commit and push
        run: |
          cd fork-clone
          git config user.name  "$(gh api user --jq '.name // .login')"
          git config user.email "$(gh api user --jq '(.id | tostring) + "+" + .login + "@users.noreply.github.com"')"
          git add -A
          if git diff --cached --quiet; then
            echo "::warning::No changes detected — branch may already be up to date"
            exit 0
          fi
          git commit -m "${{ inputs.pr_title }}"
          git push origin "$BRANCH"

      # ── 7. Open the PR on dw-0/kiauh ────────────────────────────────────
      - name: Create upstream PR
        run: |
          owner="${{ steps.whoami.outputs.owner }}"
          draft_flag=""
          if [ "${{ inputs.draft }}" = "true" ]; then
            draft_flag="--draft"
          fi
          gh pr create \
            --repo "$UPSTREAM_REPO" \
            --head "${owner}:${BRANCH}" \
            --base master \
            --title "${{ inputs.pr_title }}" \
            --body-file this-fork/docs/upstream-pr-body.md \
            $draft_flag \
          && echo "PR created successfully" \
          || echo "::warning::PR may already exist — check $UPSTREAM_REPO manually"
